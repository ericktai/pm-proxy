<html>
	<head>
		<title>AJAX Proxy</title>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
		<script type="text/javascript" src="http://static.stackmob.com/js/json2-min.js"></script>
		<script type="text/javascript" src="http://static.stackmob.com/js/underscore-1.3.3-min.js"></script>
		<script type="text/javascript" src="http://static.stackmob.com/js/backbone-0.9.2-min.js"></script>
		<script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.3.0-min.js"></script>
		<script type="text/javascript">
      StackMob.init({
        appName : "proxyexperiment",
        clientSubdomain : "tai",
        apiVersion : 0
      });

		</script>
		<script type="text/javascript">
      $(document).ready(function() {

				/**
				 * Double check to see if we can reuse logic from StackMob.js core
				 */
        window.addEventListener('message', function(event) {
          if(event.origin == "http://127.0.0.1:4567") {

            var allowedDomain = event.origin;
            var payload = JSON.parse(event.data);
            var call_id = payload['call_id'];
            var params = payload['params']

            params['success'] = function(data, status, xhr) {
            	
            	if (params["stackmob_count"] === true && xhr && xhr.getAllResponseHeaders) {
	              var responseHeader = xhr
	                  .getResponseHeader('Content-Range');
	              var count = -1;
	              if (responseHeader) {
	                count = responseHeader.substring(
	                    responseHeader.indexOf('/') + 1,
	                    responseHeader.length)
	              }
	
	              data = count;
	              
              }
              
              var payload = {
                result : 'success',
                'status' : status,
                'call_id' : call_id,
                response : data
              }
              event.source.postMessage(JSON.stringify(payload), allowedDomain);
            };
            
            params['error'] = function(jqXHR, status, errorThrown) {

              var data = null;

              if(jqXHR && (jqXHR.responseText || jqXHR.text)) {
                var result = JSON.parse(jqXHR.responseText || jqXHR.text);
                data = result;
              }
              
              var payload = {
                result : 'error',
                'status' : status,
                'call_id' : call_id,
                response : data,
                error : errorThrown
              }
              event.source.postMessage(JSON.stringify(payload), allowedDomain);
            };

            $.ajax(params);
          }

        }, false);
      });

		</script>
	</head>
	<body>
		This is the server side.
	</body>
</html>