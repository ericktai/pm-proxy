<html>
<head>
<title>AJAX Proxy</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/json2-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/underscore-1.3.3-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/backbone-0.9.2-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.3.0-min.js"></script>

<script type="text/javascript">
  StackMob.init({
    appName: "proxyexperiment",
    clientSubdomain: "tai",
    apiVersion: 0
  });
</script>

<script type="text/javascript">

  $(document).ready(function() {
  	
  	
  	
  	window.addEventListener('message', function(event) {
  		console.debug(event.origin);
        if (event.origin == "http://127.0.0.1:4567" || event.origin == null) {
        	
        	console.debug('Client is calling me!');
        	
        	var allowedDomain = !event.origin ? '*' : event.origin;
        	var params = JSON.parse(event.data);
					
					params['success'] = function(data, status, xhr) {
						var content = {
							result: 'success',
							'status': status,
							response: data
						} 
						event.source.postMessage(JSON.stringify(content),  
                           allowedDomain);	
					};
					
					params['error'] = function(xhr, status, errorThrown) {
						var content = {
							result: 'error',
							'status': status,
							response: errorThrown
						}
						event.source.postMessage(JSON.stringify(content),  
                           allowedDomain);	
					};
					
					        	
        	$.ajax(params);
        } 
        
      }, false);  
  	
  });
</script>
</head>
<body>
	This is the server side.
</body>
</html>