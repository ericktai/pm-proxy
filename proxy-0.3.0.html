<html>
	<head>
		<!--
			***********************************************************
			***********************************************************
			* STACKMOB CROSS DOMAIN PROXY - USING postMessage
			* 
			* ****************** WHAT IS THIS? ******************
			* 
			* This HTML file helps enable cross domain AJAX calls via HTML5's postMessage feature.
			* 
			* This is the complementary file to stackmob-proxy-x.x.x.js.  They work together.
			* 
			* This file should sit on a StackMob hosted server.
			* 
			* 
			* ****************** WHAT DO I NEED TO CHANGE? ******************
			* 
			* Change StackMob.init({...}) to your app's information
			* 
			* ****************** WHERE DO I PUT THIS FILE? ******************
			* 
			* This HTML file should live on a StackMob hosted server on the server-side, alongside your other HTML files.  (So go ahead and stick it in your GitHub repo).  It can be in any folder.
			* 
			* E.g.,
			* 
			* //Put it on any hosted StackMob site
			* http://yourapp.yoursubdomain.stackmobapp.com/proxy-0.3.0.html   
			* http://www.yourdomain.com/proxy-0.3.0.html  <-- assuming this is StackMob hosted using our custom domains feature
			*.
			* 
			***********************************************************
			***********************************************************
		-->
		<title>AJAX Proxy</title>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script type="text/javascript" src="http://static.stackmob.com/js/json2-min.js"></script>
		<script type="text/javascript" src="http://static.stackmob.com/js/underscore-1.4.4-min.js"></script>
		<script type="text/javascript" src="http://static.stackmob.com/js/backbone-1.0.0-min.js"></script>
		<script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.9.2-min.js"></script>
		<script type="text/javascript">
      StackMob.init({
        publicKey: 'b4670ece-8d14-4859-a149-690f4ce62bba',
        useRelativePathForAjax: true,
        apiVersion : 0
      });

		</script>
		<script type="text/javascript">
      $(document).ready(function() {

				/**
				 * Double check to see if we can reuse logic from StackMob.js core
				 */
        window.addEventListener('message', function(event) {
          if(true) {

            var allowedDomain = event.origin;
            var payload = JSON.parse(event.data);
            var call_id = payload['call_id'];
            var params = payload['params']

            params['success'] = function(data, status, xhr) {
            	
            	//Yanked from StackMob.js Core
            	if (params["stackmob_count"] === true && xhr && xhr.getAllResponseHeaders) {
	              var responseHeader = xhr
	                  .getResponseHeader('Content-Range');
	              var count = -1;
	              if (responseHeader) {
	                count = responseHeader.substring(
	                    responseHeader.indexOf('/') + 1,
	                    responseHeader.length)
	              }
	
	              data = count;
	              
              }
              
              var payload = {
                result : 'success',
                'status' : status,
                'call_id' : call_id,
                response : data
              }

console.log("allowed domain: " + allowedDomain);

              event.source.postMessage(JSON.stringify(payload), allowedDomain);
            };
            
            params['error'] = function(jqXHR, status, errorThrown) {

              var data = null;

							//Yanked from StackMob.js Core
              if(jqXHR && (jqXHR.responseText || jqXHR.text)) {
                var result = JSON.parse(jqXHR.responseText || jqXHR.text);
                data = result;
              }
              
              var payload = {
                result : 'error',
                'status' : status,
                'call_id' : call_id,
                response : data,
                error : errorThrown
              }

              event.source.postMessage(JSON.stringify(payload), allowedDomain);
            };

            $.ajax(params);
          }

        }, false);
      });

		</script>
	</head>
	<body>
	</body>
</html>